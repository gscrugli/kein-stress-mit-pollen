<!doctype html>
<html lang="en" ng-app="pollen">
  <head>
    <title>Kein Stress mit Pollen</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/leaflet.css" />
    <link rel="stylesheet" href="css/style.css" />
    <!--[if lte IE 8]>
        <link rel="stylesheet" href="css/leaflet.ie.css" />
    <![endif]-->
    <script src="js/leaflet.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.0.8/angular.min.js"></script>
    <script src="js/app.js"></script>
    <!--Jquery added for Adress search  -->
    <script src="js/jquery-1.8.2.min.js"></script>
  </head>
  <body>
    <div id="map"></div>
    <ul id="legend"></ul>
    <!--Search Address-->
    <div id="search">
  		<input type="text" name="searchadress" value="" id="addr" size="10"/>
  		<button type="button" onclick="addr_search()">Search</button> 
  		<button type="button" onclick="reset()">Reset</button> 
	</div>
    <script>
    
    //Depending on the level of allergic potential, the base Radius is either 75 (very strong), 50 (strong), 30 (medium) or 10 (low)
    var TREE_SPECS = {
      Betula:   { name: "Birke", color: '#f03', baseRadius: 75 },
      Alnus:    { name: "Erle",  color: '#30f', baseRadius: 50 },
      Corylus:  { name: "Hasel", color: '#3f0', baseRadius: 50 },
      Fraxinus: { name: "Esche", color: '#83c', baseRadius: 50 },
      Fagus:    { name: "Buche", color: '#3cf', baseRadius: 30 },
      Quercus:  { name: "Eiche", color: '#c3f', baseRadius: 30 },
      Salix:    { name: "Weide", color: '#aa6', baseRadius: 10 }
    };

    //Address pin defined
    var marker = L.icon({
  	    iconUrl: 'pics/marker.png',
  	    iconSize:     [38, 38], // size of the icon
  	    iconAnchor:   [22, 40], // point of the icon which will correspond to marker's location
     });

      for(treeType in TREE_SPECS) {
          document.getElementById("legend").innerHTML += '<li><span class="legend_color_spot" style="background-color: ' + TREE_SPECS[treeType].color + '"></span>' + TREE_SPECS[treeType].name + '</li>';
      }

      var map = L.map('map').setView([47.38, 8.53], 12);
      L.tileLayer('http://{s}.tile.cloudmade.com/BC9A493B41014CAABB98F0471D759707/997/256/{z}/{x}/{y}.png', {
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://cloudmade.com">CloudMade</a>',
        maxZoom: 18
      }).addTo(map);
      
      var addTreeToMap = function(tree) {
          window.requestAnimationFrame(function() {
            var treeColor = TREE_SPECS[tree.Baumgattung].color
            L.circle([tree.lat, tree.lon], TREE_SPECS[tree.Baumgattung].baseRadius, {
              color:       treeColor,
              fillColor:   treeColor,
              fillOpacity: 0.5
            }).addTo(map);
          });          
      };
      
      var drawTrees = function(trees) {
        for(var i=0; i < trees.length; i++) {
          addTreeToMap(trees[i]);
        }
      };
      
      var handleResult = function() {
        console.log("LOADING");
        var t_start = new Date().getTime();
        var trees = JSON.parse(this.responseText).result;
        console.log("PARSED", new Date().getTime() - t_start);  
        
        drawTrees(trees);
          
        console.log("DONE", new Date().getTime() - t_start);
      };

      //Search Button pressed
      function addr_search() {
    	  var inp = document.getElementById("addr");

    	  $.getJSON('http://nominatim.openstreetmap.org/search?format=json&limit=1&q=' + inp.value, function(data) {
    		  $.each(data, function(key, val){
    			  chooseAddr(val.lat, val.lon)
    		  });
    		  });
    		};

       //Zoom to Address (search result)
       function chooseAddr(lat, lng) {
    	  var location = new L.LatLng(lat, lng);
    	  L.marker([lat,lng], {icon: marker}).addTo(map);
    	  //map.addLayer(marker);
    	  map.panTo(location);
    	  map.setZoom(15);
    	};

       //reset Button pressed
       function reset(){
    	   map.setView([47.38, 8.53], 12);
    	};
      
      //Here the magic happens:
      (function() {
        var xhr = new XMLHttpRequest();
        var treeNames = [];
        for(treeName in TREE_SPECS) { treeNames.push(treeName); };
        
        xhr.onload = handleResult;
        xhr.open('post', 'https://data.mingle.io/');
        xhr.send(JSON.stringify({expr: '[ tree | tree <- ch_zh_baumkataster, allergenic <- ' + JSON.stringify(treeNames) + ', tree.Baumgattung == allergenic ]'})); //'expr=' + encodeURIComponent('[ tree | tree <- ch_zh_baumkataster, allergenic <- ["Betula", "Alnus"], tree.Baumgattung == allergenic ]'));
      })();
      
    </script>
  </body>
</html>
